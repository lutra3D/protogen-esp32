<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ProtoGen Web Control</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f4f6fb;
      --panel: rgba(255, 255, 255, 0.94);
      --border: rgba(28, 39, 51, 0.16);
      --accent: #616fff;
      --shadow: rgba(111, 97, 255, 0.3);
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      margin: 0;
      line-height: 1.45;
      background: radial-gradient(circle at 20% 20%, rgba(255, 179, 140, 0.18), transparent 46%),
        radial-gradient(circle at 80% 0%, rgba(107, 164, 255, 0.18), transparent 44%),
        var(--bg);
      color: #1c2733;
      min-height: 100vh;
    }

    .page {
      max-width: 880px;
      margin: 32px auto 48px;
      padding: 0 20px 32px;
    }

    h1 {
      margin: 0 0 24px;
      text-align: center;
      font-size: 2.2rem;
      letter-spacing: 0.02em;
      color: #18202a;
    }

    section {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 18px 20px 22px;
      margin-bottom: 22px;
      border-radius: 18px;
      box-shadow: 0 12px 28px rgba(23, 43, 77, 0.12);
      backdrop-filter: blur(7px);
    }

    section h2 {
      margin: 0 0 12px;
      font-size: 1.05rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #4e5d6c;
    }

    form {
      display: grid;
      gap: 12px;
    }

    label {
      font-weight: 600;
      color: #3b4a5a;
      display: block;
    }

    input,
    button {
      font: inherit;
      border-radius: 10px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.15s ease;
    }

    input[type="text"],
    input[type="file"],
    input[type="range"],
    input[type="color"] {
      border: 1px solid var(--border);
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.82);
      color: inherit;
    }

    input[type="file"] {
      padding: 6px 0;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(255, 111, 97, 0.);
    }

    input[type="color"] {
      padding: 0;
      width: 68px;
      height: 42px;
      cursor: pointer;
    }

    input[type="range"] {
      accent-color: var(--accent);
      width: 220px;
      height: 36px;
    }

    button {
      border: none;
      background: linear-gradient(135deg, var(--accent), #a172ff);
      color: #fff;
      font-weight: 600;
      padding: 10px 18px;
      cursor: pointer;
      box-shadow: 0 10px 20px var(--shadow);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px var(--shadow);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px var(--shadow);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
    }

    .row label {
      margin-top: 0;
      flex: 1 1 140px;
    }

    .row input[type="text"],
    .row input[type="range"] {
      flex: 2 1 220px;
    }

    .row input[type="color"] {
      flex: 0 0 auto;
    }

    .row button {
      flex: 0 0 auto;
    }

    .emotion-buttons {
      gap: 10px;
      justify-content: flex-start;
    }

    .emotion-buttons button {
      flex: 0 0 auto;
      background: rgba(97, 111, 255, 0.12);
      color: #3b4a5a;
      box-shadow: none;
      border: 1px solid rgba(97, 111, 255, 0.25);
      padding: 8px 14px;
    }

    .emotion-buttons button:hover {
      background: rgba(97, 111, 255, 0.2);
    }

    .emotion-buttons button.is-active {
      background: linear-gradient(135deg, var(--accent), #a172ff);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 16px var(--shadow);
    }

    .emotion-empty {
      color: #5a6a7b;
      font-style: italic;
    }

    .display-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .display-row>.value-display {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 160px;
    }

    .icon-button {
      width: 38px;
      height: 38px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      line-height: 1;
    }

    .file-list {
      margin-top: 16px;
      display: grid;
      gap: 10px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.78);
      box-shadow: 0 6px 14px rgba(23, 43, 77, 0.1);
      gap: 12px;
    }

    .file-item.empty {
      justify-content: center;
      color: #5a6a7b;
      font-style: italic;
    }

    .file-name {
      font-weight: 600;
      word-break: break-word;
    }

    .delete-button {
      background: rgba(238, 64, 64, 0.12);
      color: #d14949;
      box-shadow: none;
      border: 1px solid rgba(209, 73, 73, 0.2);
    }

    .delete-button:hover {
      background: rgba(238, 64, 64, 0.18);
      box-shadow: none;
    }

    .status {
      font-size: 0.9rem;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(24, 32, 42, 0.06);
      border: 1px solid rgba(24, 32, 42, 0.1);
      white-space: pre-wrap;
    }

    pre.status {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }

    .value {
      font-weight: 600;
      color: #1a2530;
    }

    @media (max-width: 640px) {
      .page {
        margin: 24px auto 32px;
        padding: 0 14px 28px;
      }

      .row {
        flex-direction: column;
        align-items: stretch;
      }

      .row>* {
        width: 100%;
      }

      input[type="range"] {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <main class="page">
    <h1>Protogen Web Control</h1>

    <section>
      <h2>Animation Files</h2>
      <form id="uploadForm">
        <div class="display-row">
          <label for="fileInput">
            File:
          </label>
          <input id="fileInput" type="file" accept=".gif" required>
        </div>
        <div class="display-row">
          <label for="fileName">
            Name:
          </label>
          <input id="fileName" type="text" placeholder="example.gif" required>
        </div>
      <div class="row">
        <button type="submit">Upload</button>
      </div>
      </form>
      <div id="uploadStatus" class="status"></div>
      <div id="filesStatus" class="status"></div>
      <div id="fileList" class="file-list" aria-live="polite"></div>
    </section>

    <section>
      <h2>Emotion</h2>
      <div class="display-row">
        <div class="value-display">Current: <span id="emotionCurrent" class="value">--</span></div>
        <button id="emotionRefresh" class="icon-button" type="button" aria-label="Refresh emotion"
          title="Refresh">↻</button>
      </div>
      <div id="emotionButtons" class="row emotion-buttons" aria-live="polite"></div>
      <div id="emotionStatus" class="status"></div>
    </section>

    <section>
      <h2>Fan</h2>
      <div class="display-row">
        <div class="value-display">Duty: <span id="fanDuty" class="value">--</span> | Percent: <span id="fanPercent"
            class="value">--</span>%</div>
        <button id="fanRefresh" class="icon-button" type="button" aria-label="Refresh fan" title="Refresh">↻</button>
      </div>
      <div class="row">
        <label for="fanSlider">Speed (%)</label>
        <input id="fanSlider" type="range" min="0" max="100" value="0">
        <span id="fanSliderValue" class="value">0%</span>
        <button id="fanApply" type="button">Apply</button>
      </div>
      <div id="fanStatus" class="status"></div>
    </section>

    <section>
      <h2>Ears</h2>
      <div class="display-row">
        <div class="value-display">Color: <span id="earColorText" class="value">--</span> | Brightness: <span
            id="earBrightnessText" class="value">--</span></div>
        <button id="earRefresh" class="icon-button" type="button" aria-label="Refresh ears" title="Refresh">↻</button>
      </div>
      <div class="row">
        <label for="earColor">Color</label>
        <input id="earColor" type="color" value="#ffffff">
        <label for="earBrightness">Brightness</label>
        <input id="earBrightness" type="range" min="0" max="255" value="128">
        <span id="earBrightnessValue" class="value">128</span>
        <button id="earApply" type="button">Apply</button>
      </div>
      <div id="earStatus" class="status"></div>
    </section>

    <section>
      <h2>Heap Status</h2>
      <div class="display-row">
        <div class="value-display">Value: <span id="heapValue" class="value">--</span></div>
        <button id="heapRefresh" class="icon-button" type="button" aria-label="Refresh heap status"
          title="Refresh">↻</button>
      </div>
      <div id="heapStatus" class="status"></div>
    </section>

    <section>
      <h2>Gyroscope</h2>
      <div class="display-row">
        <div class="value-display">Value: <span id="gyroValue" class="value">--</span></div>
        <button id="gyroRefresh" class="icon-button" type="button" aria-label="Refresh gyroscope"
          title="Refresh">↻</button>
      </div>
      <div id="gyroStatus" class="status"></div>
    </section>
    <p>Lutra 3D, 2025</p>
  </main>

  <script>
    (function () {
      function $(id) { return document.getElementById(id); }
      function setText(node, text) { node.textContent = text; }

      var uploadForm = $("uploadForm");
      var fileInput = $("fileInput");
      var fileNameInput = $("fileName");
      var uploadStatus = $("uploadStatus");
      var fileList = $("fileList");
      var filesStatus = $("filesStatus");
      var emotionCurrent = $("emotionCurrent");
      var emotionStatus = $("emotionStatus");
      var emotionButtons = $("emotionButtons");
      var currentEmotionName = "";
      var fanDuty = $("fanDuty");
      var fanPercent = $("fanPercent");
      var fanSlider = $("fanSlider");
      var fanSliderValue = $("fanSliderValue");
      var fanStatus = $("fanStatus");
      var earColor = $("earColor");
      var earColorText = $("earColorText");
      var earBrightness = $("earBrightness");
      var earBrightnessText = $("earBrightnessText");
      var earBrightnessValue = $("earBrightnessValue");
      var earStatus = $("earStatus");
      var heapValue = $("heapValue");
      var heapStatus = $("heapStatus");
      var gyroValue = $("gyroValue");
      var gyroStatus = $("gyroStatus");

      fileInput.addEventListener("change", function () {
        if (fileInput.files.length && !fileNameInput.value) {
          fileNameInput.value = fileInput.files[0].name;
        }
      });

      fanSlider.addEventListener("input", function () {
        setText(fanSliderValue, fanSlider.value + "%");
      });

      earBrightness.addEventListener("input", function () {
        setText(earBrightnessValue, earBrightness.value);
      });

      function fetchText(url, options) {
        return fetch(url, options).then(function (response) {
          return response.text().then(function (text) {
            if (!response.ok) { throw new Error(text || response.statusText); }
            return text;
          });
        });
      }

      function fetchJson(url, options) {
        return fetch(url, options).then(function (response) {
          return response.text().then(function (text) {
            if (!response.ok) { throw new Error(text || response.statusText); }
            if (!text) { return []; }
            try {
              return JSON.parse(text);
            } catch (error) {
              throw new Error("Invalid JSON response");
            }
          });
        });
      }

      function highlightEmotion(name) {
        var active = (name || "").trim();
        var buttons = emotionButtons.querySelectorAll("[data-emotion]");
        buttons.forEach(function (button) {
          var matches = button.getAttribute("data-emotion") === active;
          button.classList.toggle("is-active", matches);
          button.setAttribute("aria-pressed", matches ? "true" : "false");
        });
      }

      function refreshEmotion(options) {
        var preserveStatus = options && options.preserveStatus;
        return fetchText("/emotion").then(function (text) {
          var value = (text || "").trim();
          currentEmotionName = value;
          setText(emotionCurrent, value || "(empty)");
          highlightEmotion(currentEmotionName);
          if (!preserveStatus) {
            setText(emotionStatus, "");
          }
          return value;
        }).catch(function (error) {
          if (!preserveStatus) {
            setText(emotionStatus, "Error: " + error.message);
          }
          return null;
        });
      }

      function renderEmotionButtons(files) {
        emotionButtons.innerHTML = "";
        var list = Array.isArray(files) ? files : [];
        if (!list.length) {
          var empty = document.createElement("div");
          empty.className = "emotion-empty";
          empty.textContent = "No emotions available.";
          emotionButtons.appendChild(empty);
          return;
        }

        var fragment = document.createDocumentFragment();
        list.forEach(function (name) {
          var button = document.createElement("button");
          button.type = "button";
          button.textContent = name;
          button.setAttribute("data-emotion", name);
          button.setAttribute("aria-pressed", "false");
          fragment.appendChild(button);
        });
        emotionButtons.appendChild(fragment);
        highlightEmotion(currentEmotionName);
      }

      function setEmotion(name) {
        var body = new URLSearchParams({ name: name });
        return fetchText("/emotion", {
          method: "PUT",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body
        });
      }

      function refreshFan() {
        fetchText("/fan").then(function (dutyString) {
          var duty = parseInt(dutyString, 10);
          var percent = isFinite(duty) ? Math.round(duty * 100 / 255) : NaN;
          setText(fanDuty, isFinite(duty) ? duty : "--");
          setText(fanPercent, isFinite(percent) ? percent : "--");
          if (isFinite(percent)) {
            fanSlider.value = percent;
            setText(fanSliderValue, percent + "%");
          }
          setText(fanStatus, "");
        }).catch(function (error) {
          setText(fanStatus, "Error: " + error.message);
        });
      }

      function applyFan() {
        var percent = parseInt(fanSlider.value, 10) || 0;
        var duty = Math.round(percent * 255 / 100);
        var body = new URLSearchParams({ duty: String(duty) });
        fetchText("/fan", {
          method: "PUT",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body
        }).then(function (text) {
          setText(fanStatus, text);
          refreshFan();
        }).catch(function (error) {
          setText(fanStatus, "Error: " + error.message);
        });
      }

      function refreshEars() {
        fetchText("/ears").then(function (response) {
          var parts = response.trim().split(/\s+/);
          var color = (parts[0] || "#ffffff").toLowerCase();
          var brightness = parseInt(parts[1] || "0", 10);
          setText(earColorText, color);
          setText(earBrightnessText, isFinite(brightness) ? brightness : "--");
          if (/^#[0-9a-f]{6}$/i.test(color)) {
            earColor.value = color;
          }
          if (isFinite(brightness)) {
            earBrightness.value = brightness;
            setText(earBrightnessValue, brightness);
          }
          setText(earStatus, "");
        }).catch(function (error) {
          setText(earStatus, "Error: " + error.message);
        });
      }

      function applyEars() {
        var body = new URLSearchParams({
          color: earColor.value,
          brightness: earBrightness.value
        });
        fetchText("/ears", {
          method: "PUT",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body
        }).then(function (text) {
          setText(earStatus, text);
          refreshEars();
        }).catch(function (error) {
          setText(earStatus, "Error: " + error.message);
        });
      }

      function refreshHeap() {
        fetchText("/heap").then(function (text) {
          setText(heapValue, text);
          setText(heapStatus, "");
        }).catch(function (error) {
          setText(heapValue, "--");
          setText(heapStatus, "Error: " + error.message);
        });
      }

      function refreshGyro() {
        fetchText("/gyro").then(function (text) {
          setText(gyroValue, text);
          setText(gyroStatus, "");
        }).catch(function (error) {
          setText(gyroValue, "--");
          setText(gyroStatus, "Error: " + error.message);
        });
      }

      uploadForm.addEventListener("submit", function (event) {
        event.preventDefault();
        if (!fileInput.files.length) {
          setText(uploadStatus, "Please choose a file.");
          return;
        }
        var file = fileInput.files[0];
        var name = fileNameInput.value.trim() || file.name;
        if (!name) {
          setText(uploadStatus, "File name is required.");
          return;
        }
        setText(uploadStatus, "Uploading...");

        var formData = new FormData();
        formData.append("file", file, name);
        fetchText("/file", {
          method: "POST",
          body: formData
        }).then(function (text) {
          setText(uploadStatus, text);
          refreshFiles();
        }).catch(function (error) {
          setText(uploadStatus, "Error: " + error.message);
        });
      });

      function renderFileList(files) {
        fileList.innerHTML = "";
        if (!files.length) {
          var empty = document.createElement("div");
          empty.className = "file-item empty";
          empty.textContent = "No animation files uploaded.";
          fileList.appendChild(empty);
          return;
        }

        var fragment = document.createDocumentFragment();
        files.forEach(function (name) {
          var item = document.createElement("div");
          item.className = "file-item";

          var label = document.createElement("span");
          label.className = "file-name";
          label.textContent = name;

          var button = document.createElement("button");
          button.type = "button";
          button.className = "icon-button delete-button";
          button.setAttribute("data-file-delete", name);
          button.setAttribute("aria-label", "Delete " + name);
          button.title = "Delete";
          button.textContent = "🗑";

          item.appendChild(label);
          item.appendChild(button);
          fragment.appendChild(item);
        });

        fileList.appendChild(fragment);
      }

      function refreshFiles() {
        fetchJson("/files").then(function (files) {
          var list = Array.isArray(files) ? files : [];
          renderFileList(list);
          renderEmotionButtons(list);
          setText(filesStatus, "");
        }).catch(function (error) {
          renderFileList([]);
          renderEmotionButtons([]);
          setText(filesStatus, "Error: " + error.message);
          if (!emotionStatus.textContent) {
            setText(emotionStatus, "Error loading emotions: " + error.message);
          }
        });
      }

      function deleteFile(name) {
        fetchText("/file?file=" + encodeURIComponent(name), { method: "DELETE" })
          .then(function (text) {
            setText(filesStatus, text);
            refreshFiles();
          })
          .catch(function (error) {
            setText(filesStatus, "Error: " + error.message);
          });
      }

      fileList.addEventListener("click", function (event) {
        var button = event.target.closest("[data-file-delete]");
        if (!button) { return; }
        var name = button.getAttribute("data-file-delete") || "";
        if (name) {
          deleteFile(name);
        }
      });

      $("emotionRefresh").addEventListener("click", function () {
        refreshEmotion();
        refreshFiles();
      });

      emotionButtons.addEventListener("click", function (event) {
        var button = event.target.closest("[data-emotion]");
        if (!button) { return; }
        var name = button.getAttribute("data-emotion") || "";
        if (!name) { return; }
        setText(emotionStatus, "Updating emotion...");
        setEmotion(name).then(function (text) {
          currentEmotionName = name;
          setText(emotionCurrent, name);
          highlightEmotion(currentEmotionName);
          setText(emotionStatus, text);
        }).catch(function (error) {
          setText(emotionStatus, "Error: " + error.message);
        });
      });
      $("fanRefresh").addEventListener("click", refreshFan);
      $("fanApply").addEventListener("click", applyFan);
      $("earRefresh").addEventListener("click", refreshEars);
      $("earApply").addEventListener("click", applyEars);
      $("heapRefresh").addEventListener("click", refreshHeap);
      $("gyroRefresh").addEventListener("click", refreshGyro);

      refreshFiles();
      refreshEmotion();
      refreshFan();
      refreshEars();
      refreshHeap();
      refreshGyro();
    })();
  </script>
</body>

</html>